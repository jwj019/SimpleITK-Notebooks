name: Static Notebook Generation

on:
  push: 

jobs:
  build:
    strategy:
      matrix:
        python-version: [3.8]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout gh-pages
      uses: actions/checkout@v2
      with:
        ref: gh-pages
    - name: Checkout Python folder and scripts
      run: |
        git fetch --all
        git checkout origin/${GITHUB_REF##*/} -- Python/
        git checkout origin/${GITHUB_REF##*/} -- generate_static_pages.py
        git checkout origin/${GITHUB_REF##*/} -- requirements_dev.txt
        git checkout origin/${GITHUB_REF##*/} -- Data/manifest.json
        git checkout origin/${GITHUB_REF##*/} -- Utilities
        git reset HEAD
    - uses: actions/cache@v2
      with:
        path: |
          Data
        key: notebook-data-{{ checksum "Data/manifest.json" }}
        restore-keys: |
          notebook-data-{{ checksum "Data/manifest.json" }}
          notebook-data-
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install enchant
        python3 -m pip install --upgrade pip
        pip3 install virtualenv jupyter pandadocs nbconvert notebooktoall
        virtualenv ~/sitkpy
        ~/sitkpy/bin/pip3 install -r requirements_dev.txt --pre --find-links https://github.com/SimpleITK/SimpleITK/releases/tag/latest
        ~/sitkpy/bin/jupyter nbextension enable --py --sys-prefix widgetsnbextension
    - name: Install Fiji
      run: |
        mkdir -p ~/bin
        wget -P ~/bin https://downloads.imagej.net/fiji/latest/fiji-linux64.zip  
        unzip ~/bin/fiji-linux64.zip -d ~/bin
        export PATH=$PATH:~/bin/Fiji.app
    - name: Generate static pages
      env: 
        SIMPLE_ITK_MEMORY_CONSTRAINED_ENVIRONMENT: 1
      run: |
        source ~/sitkpy/bin/activate
        # ~/sitkpy/bin/python3 generate_static_pages.py
    - name: Copy image files
      run: |
        ls -la
        ls -la Python
        cp -L Python/*.png Python_html
        cp -L Python/*.svg Python_html
        cp -L Python/*.jpg Python_html
    - name: Commit and push files
      run: |
        git branch
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "Update static notebooks" -a
        git push
